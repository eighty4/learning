cmake_minimum_required(VERSION 3.19)
project(.)

set(TARGET_CPU x64)
if (WIN32 AND CMAKE_GENERATOR_PLATFORM MATCHES Win32)
    set(TARGET_CPU x86)
endif ()

set(WEBRTC_CUT debug)
if (CMAKE_BUILD_TYPE MATCHES Release)
    set(WEBRTC_CUT release)
endif ()

if (NOT DEFINED ${WEBRTC_CMT})
    if (CMAKE_BUILD_TYPE MATCHES Release)
        message(FATAL_ERROR "set WEBRTC_CMT for release build")
    else ()
        set(WEBRTC_CMT latest)
    endif ()
endif ()

message("linking libwebrtc ${WEBRTC_CMT} ${WEBRTC_CUT} ${TARGET_CPU} build")

set(WEBRTC_HEADERS_DIR webrtc/src/out/${WEBRTC_CMT}/headers)
if (NOT IS_DIRECTORY ${WEBRTC_HEADERS_DIR})
    message(FATAL_ERROR "webrtc headers missing at ${WEBRTC_HEADERS_DIR}")
endif ()

set(WEBRTC_BUILD_DIR webrtc/src/out/${WEBRTC_CMT}/${TARGET_CPU}/${WEBRTC_CUT})
if (NOT IS_DIRECTORY ${WEBRTC_BUILD_DIR})
    message(FATAL_ERROR "webrtc build output missing at ${WEBRTC_BUILD_DIR}")
endif ()

if (WIN32)
    set(WEBRTC_LIB_NAME webrtc.lib)
    set(WEBRTC_COMPILE_DEFINITIONS -DWEBRTC_WIN)
    set(WEBRTC_PLATFORM_LIBS ws2_32 d3d11 dxgi winmm ucrt)
elseif (APPLE)
    set(WEBRTC_LIB_NAME libwebrtc.a)
    set(WEBRTC_COMPILE_DEFINITIONS -DWEBRTC_MAC -DWEBRTC_POSIX)
    #    find_library(APPLICATION_SERVICES ApplicationServices)
    #    find_library(CORE_FOUNDATION Foundation)
    #    find_library(CORE_SERVICES CoreServices)
    #    find_library(CORE_AUDIO CoreAudio)
    #    find_library(AUDIO_TOOLBOX AudioToolbox)
    find_library(IO_SURFACE IOSurface)
    find_library(COCOA Cocoa)
    set(WEBRTC_PLATFORM_LIBS ${IO_SURFACE} ${COCOA})
else ()
    message(FATAL_ERROR "libwebrtc platform not yet supported on ${CMAKE_SYSTEM_NAME}")
endif ()

set(WEBRTC_LIB_FILE ${WEBRTC_BUILD_DIR}/obj/${WEBRTC_LIB_NAME})
if (NOT EXISTS ${WEBRTC_LIB_FILE})
    message(FATAL_ERROR "libwebrtc not found at ${WEBRTC_LIB_FILE}")
endif ()

set(WEBRTC_DEFINITIONS ${WEBRTC_COMPILE_DEFINITIONS} PARENT_SCOPE)
set(WEBRTC_HEADERS ${WEBRTC_HEADERS_DIR} ${WEBRTC_HEADERS_DIR}/webrtc PARENT_SCOPE)
set(WEBRTC_LIBS ${WEBRTC_LIB_FILE} ${WEBRTC_PLATFORM_LIBS} PARENT_SCOPE)
